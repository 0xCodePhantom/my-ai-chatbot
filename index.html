<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant • Premium Chat</title>
    <meta name="description" content="A clean, fast, professional AI chat experience – inspired by ChatGPT & Grok.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --header-bg: #161b22;
            --chat-bg: #0d1117;
            --text: #f0f8ff;
            --text-secondary: #8b949e;
            --user-bubble: #238636;
            --ai-bubble: #21262d;
            --accent: #58a6ff;
            --border: #30363d;
        }
        [data-theme="light"] {
            --bg: #ffffff;
            --header-bg: #f6f8fa;
            --chat-bg: #ffffff;
            --text: #24292f;
            --text-secondary: #57606a;
            --user-bubble: #2ea44f;
            --ai-bubble: #f6f8fa;
            --accent: #0969da;
            --border: #d0d7de;
        }
        body { background: var(--bg); color: var(--text); min-height: 100vh; margin: 0; font-family: system-ui, -apple-system, sans-serif; display: flex; flex-direction: column; }
        header { background: var(--header-bg); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 1.6rem; font-weight: 600; margin: 0; }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        .header-actions button { background: none; border: none; color: var(--text); font-size: 1.4rem; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: background 0.2s; }
        .header-actions button:hover { background: var(--accent)20; }
        #new-chat-btn { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.95rem; }
        #chat-container { flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; max-width: 800px; margin: 0 auto; width: 100%; }
        .message { display: flex; gap: 1rem; max-width: 100%; animation: fadeIn 0.4s ease; }
        .message.user { justify-content: flex-end; }
        .bubble { padding: 1rem 1.5rem; border-radius: 18px; max-width: 80%; line-height: 1.6; }
        .user .bubble { background: var(--user-bubble); color: white; border-bottom-right-radius: 4px; }
        .ai .bubble { background: var(--ai-bubble); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .message-actions { margin-top: 0.5rem; opacity: 0; transition: opacity 0.3s; display: flex; gap: 1rem; }
        .ai:hover .message-actions { opacity: 1; }
        .message-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.1rem; }
        .message-actions button:hover { color: var(--accent); }
        #input-container { background: var(--header-bg); border-top: 1px solid var(--border); padding: 1rem 2rem; }
        #input-area { max-width: 800px; margin: 0 auto; display: flex; align-items: flex-end; gap: 1rem; background: var(--bg-tertiary); border-radius: 24px; padding: 0.8rem 1.2rem; border: 1px solid var(--border); }
        #user-input { flex: 1; background: transparent; border: none; outline: none; color: var(--text); font-size: 1.1rem; resize: none; max-height: 200px; overflow-y: auto; line-height: 1.5; }
        #send-btn, #stop-btn { background: var(--accent); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        #stop-btn { background: #da3633; display: none; }
        .typing-indicator { display: flex; gap: 0.5rem; }
        .dot { width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        pre { background: #161b22; color: #f0f8ff; padding: 1rem; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border); }
        code { background: rgba(88,166,255,0.2); padding: 0.2rem 0.5rem; border-radius: 4px; }
        .model-info { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; }
        @media (max-width: 768px) {
            header, #input-container { padding: 1rem; }
            #chat-container { padding: 1rem; }
            .bubble { max-width: 90%; }
        }
    </style>
</head>
<body>
    <header>
        <h1>AI Assistant</h1>
        <div class="header-actions">
            <button id="new-chat-btn">New Chat</button>
            <button id="theme-toggle" title="Toggle Theme"><i class="fas fa-moon"></i></button>
        </div>
    </header>

    <div id="chat-container"></div>

    <div id="input-container">
        <div id="input-area">
            <textarea id="user-input" placeholder="Send a message..." rows="1"></textarea>
            <button id="stop-btn"><i class="fas fa-stop"></i></button>
            <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const md = markdownit({ html: true, breaks: true, linkify: true });

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const newChatBtn = document.getElementById('new-chat-btn');
        const BACKEND_URL = '/chat';

        let conversationHistory = JSON.parse(localStorage.getItem('simpleChatHistory')) || [];
        let currentController = null;

        // Theme
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.dataset.theme = savedTheme;
        themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

        // Load history
        conversationHistory.forEach(msg => addMessage(msg.role, msg.content));

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.classList.add('message', role);
            div.innerHTML = `
                <div class="bubble">
                    ${role === 'assistant' ? md.render(content) : content.replace(/\n/g, '<br>')}
                </div>
                ${role === 'assistant' ? `
                <div class="message-actions">
                    <button title="Copy"><i class="fas fa-copy"></i></button>
                    <button title="Regenerate"><i class="fas fa-redo"></i></button>
                </div>` : ''}
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (role === 'assistant') {
                div.querySelector('.fa-copy').onclick = () => {
                    navigator.clipboard.writeText(content);
                    alert('Copied!');
                };
                div.querySelector('.fa-redo').onclick = regenerateLast;
            }
            return div;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });
            saveHistory();

            userInput.value = '';
            autoResize();
            sendBtn.disabled = true;
            stopBtn.style.display = 'flex';
            sendBtn.style.display = 'none';

            const aiMsg = addMessage('assistant', '');
            const bubble = aiMsg.querySelector('.bubble');
            bubble.innerHTML = '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';

            let reply = '';
            try {
                currentController = new AbortController();
                const res = await fetch(BACKEND_URL, {
                    method: 'POST',
                    signal: currentController.signal,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'system', content: 'You are a helpful AI assistant.' }, ...conversationHistory],
                        model: 'llama-3.1-8b-instant',
                        temperature: 0.7,
                        max_tokens: 4096,
                        stream: true
                    })
                });

                if (!res.ok) throw new Error(await res.text());

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                bubble.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const delta = data.choices[0]?.delta?.content;
                                if (delta) {
                                    reply += delta;
                                    bubble.innerHTML = md.render(reply);
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            } catch (e) {}
                        }
                    }
                }

                conversationHistory.push({ role: 'assistant', content: reply });
                saveHistory();
            } catch (err) {
                if (err.name !== 'AbortError') {
                    bubble.innerHTML = `<em style="color:#da3633;">Error: ${err.message}</em>`;
                }
            } finally {
                sendBtn.disabled = false;
                stopBtn.style.display = 'none';
                sendBtn.style.display = 'flex';
                currentController = null;
            }
        }

        function regenerateLast() {
            if (conversationHistory.length < 2) return;
            conversationHistory.pop();
            chatContainer.removeChild(chatContainer.lastChild);
            saveHistory();
            sendMessage();
        }

        stopBtn.onclick = () => {
            if (currentController) currentController.abort();
            sendBtn.disabled = false;
            stopBtn.style.display = 'none';
            sendBtn.style.display = 'flex';
        };

        function autoResize() {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        }

        sendBtn.onclick = sendMessage;
        userInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        userInput.addEventListener('input', autoResize);
        autoResize();

        themeToggle.onclick = () => {
            const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.dataset.theme = newTheme;
            localStorage.setItem('theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        };

        newChatBtn.onclick = () => {
            if (confirm('Start new chat? Current history will be cleared.')) {
                conversationHistory = [];
                saveHistory();
                chatContainer.innerHTML = '';
            }
        };

        function saveHistory() {
            localStorage.setItem('simpleChatHistory', JSON.stringify(conversationHistory));
        }
    </script>
</body>
</html>
